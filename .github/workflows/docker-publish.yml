name: Docker Build and Publish

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  REGISTRY: registry.k8s.sindrema.com
  IMAGE_NAME: images/teslamap
  K8S_REPO: SindreMA/sindre-k8s
  K8S_DEPLOYMENT_PATH: manifests/useful-services/teslamap-deployment.yaml

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      image-tag: ${{ steps.timestamp.outputs.tag }}
      image-tags: ${{ steps.meta.outputs.tags }}
      image-labels: ${{ steps.meta.outputs.labels }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate timestamp tag
        id: timestamp
        run: echo "tag=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.timestamp.outputs.tag }}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=docker,dest=/tmp/image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/image.tar
          retention-days: 1

  push:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      packages: write

    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/image.tar

      - name: Log in to Harbor Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Push Docker image
        run: docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-tag }}

  deploy:
    runs-on: ubuntu-latest
    needs: [build, push]
    permissions:
      contents: read

    steps:
      - name: Checkout k8s manifests repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.K8S_REPO }}
          path: k8s-repo
          token: ${{ secrets.GH_PAT }}

      - name: Update Kubernetes deployment
        run: |
          IMAGE_TAG="${{ needs.build.outputs.image-tag }}"
          echo "Updating deployment to use image tag: ${IMAGE_TAG}"
          echo "Deployment file: ${K8S_DEPLOYMENT_PATH}"

          # Show current state
          echo "Before update:"
          cat "k8s-repo/${K8S_DEPLOYMENT_PATH}" | grep "image:" || echo "No image line found"

          # Update the deployment file - match any tag after the image name
          sed -i.bak "s|image: ${REGISTRY}/${IMAGE_NAME}:.*|image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}|g" \
            "k8s-repo/${K8S_DEPLOYMENT_PATH}"

          # Also try without the full registry path in case format differs
          sed -i.bak "s|image: ${IMAGE_NAME}:.*|image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}|g" \
            "k8s-repo/${K8S_DEPLOYMENT_PATH}"

          # Show the result
          echo "After update:"
          cat "k8s-repo/${K8S_DEPLOYMENT_PATH}" | grep "image:"

          # Check if file actually changed
          if ! diff -q "k8s-repo/${K8S_DEPLOYMENT_PATH}.bak" "k8s-repo/${K8S_DEPLOYMENT_PATH}" > /dev/null 2>&1; then
            echo "File was successfully updated"
          else
            echo "Warning: File did not change, forcing update anyway"
            # Force an update by ensuring the tag is written
            sed -i "s|image:.*${IMAGE_NAME}.*|image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}|g" \
              "k8s-repo/${K8S_DEPLOYMENT_PATH}"
          fi
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          K8S_DEPLOYMENT_PATH: ${{ env.K8S_DEPLOYMENT_PATH }}

      - name: Commit and push deployment update
        run: |
          cd k8s-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          IMAGE_TAG="${{ needs.build.outputs.image-tag }}"

          # Show what we're about to commit
          echo "Git status:"
          git status

          git add "${K8S_DEPLOYMENT_PATH}"

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes detected. The deployment file may already be at the correct version."
            echo "Current image in deployment:"
            cat "${K8S_DEPLOYMENT_PATH}" | grep "image:"
          else
            echo "Committing changes..."
            git commit -m "Update teslamap deployment to image tag ${IMAGE_TAG}"
            git push
            echo "Successfully pushed deployment update!"
          fi
        env:
          K8S_DEPLOYMENT_PATH: ${{ env.K8S_DEPLOYMENT_PATH }}
